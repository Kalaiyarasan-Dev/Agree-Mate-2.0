<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AgriMate тАФ Smart Farming Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
    .animate-fade-in { animation: fadeIn .4s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .nav-item.active { color: #15803d; border-bottom: 2px solid #15803d; }
    .hidden { display: none !important; }
    .eco-meter { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .eco-fill { height: 100%; transition: width 1s ease-in-out; }
    .timeline-item.current { border-left-color: #22c55e; background-color: #f0fdf4; }
    
    /* Marquee Animation */
    .marquee-container { overflow: hidden; white-space: nowrap; position: relative; background: #064e3b; color: white; }
    .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
  </style>
</head>
<body class="text-gray-800 pb-20">

  <!-- MARKET TICKER (New Feature) -->
  <div class="marquee-container py-2 text-xs font-semibold tracking-wide">
      <div class="marquee-content" id="market-ticker">
          Loading market trends...
      </div>
  </div>

  <!-- Mobile Top Bar -->
  <div class="bg-white shadow-sm p-4 sticky top-0 z-20 flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <i data-lucide="sprout" class="text-green-600 h-6 w-6"></i>
      <h1 class="text-xl font-bold text-green-800" data-i18n="appTitle">AgriMate</h1>
    </div>
    <div class="flex items-center space-x-3">
        <button id="locationBtn" onclick="detectLocation()" class="p-2 bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition" title="Auto-detect Location">
            <i data-lucide="map-pin" class="h-5 w-5"></i>
        </button>
        <select id="languageSelector" class="bg-gray-50 border border-gray-300 text-gray-700 py-1 px-2 rounded-lg text-sm">
            <option value="en">ENG</option>
            <option value="ta">родрооро┐ро┤рпН</option>
        </select>
    </div>
  </div>

  <!-- Main Content Area -->
  <main class="container mx-auto max-w-3xl p-4">
    
    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="view-section animate-fade-in">
        <!-- Weather Card -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 opacity-10 transform translate-x-4 -translate-y-4">
                <i data-lucide="cloud-sun" class="h-32 w-32"></i>
            </div>
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-blue-100 text-sm font-medium" id="dash-date">Today</p>
                        <h2 class="text-3xl font-bold mt-1" id="dash-location">Detecting...</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-4xl font-bold" id="dash-temp">--┬░C</p>
                        <p class="text-blue-100" id="dash-condition">Loading...</p>
                    </div>
                </div>
                <div class="mt-6 flex space-x-6 text-sm text-blue-100">
                    <div class="flex items-center"><i data-lucide="wind" class="h-4 w-4 mr-1"></i> <span id="dash-wind">-- km/h</span></div>
                    <div class="flex items-center"><i data-lucide="droplets" class="h-4 w-4 mr-1"></i> <span id="dash-rain">-- mm</span></div>
                </div>
            </div>
        </div>

        <!-- Action Grid -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div onclick="switchView('planner')" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer flex flex-col items-center text-center">
                <div class="bg-green-100 p-3 rounded-full mb-3 text-green-600"><i data-lucide="calendar-days" class="h-6 w-6"></i></div>
                <h3 class="font-bold text-gray-800" data-i18n="cropPlanner">Crop Planner</h3>
                <p class="text-xs text-gray-500 mt-1" data-i18n="planNew">Plan new cultivation</p>
            </div>
            <div onclick="switchView('diagnosis')" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer flex flex-col items-center text-center">
                <div class="bg-red-100 p-3 rounded-full mb-3 text-red-600"><i data-lucide="scan-line" class="h-6 w-6"></i></div>
                <h3 class="font-bold text-gray-800" data-i18n="cropDoctor">Crop Doctor</h3>
                <p class="text-xs text-gray-500 mt-1" data-i18n="diagnoseDisease">Diagnose diseases</p>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="history" class="h-4 w-4 mr-2"></i> <span data-i18n="recentPlans">Recent Plans</span></h3>
            <div id="history-list" class="space-y-3">
                <p class="text-gray-400 text-sm text-center py-4">No recent plans found.</p>
            </div>
        </div>
    </div>

    <!-- VIEW: PLANNER -->
    <div id="view-planner" class="view-section hidden animate-fade-in">
        <h2 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="clipboard-list" class="mr-2 text-green-600"></i> <span data-i18n="newPlan">New Cultivation Plan</span></h2>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <form id="planForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-600 mb-1 block" data-i18n="district">District</label>
                        <select id="district" class="w-full p-3 rounded-lg border bg-gray-50 focus:ring-2 focus:ring-green-500"></select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600 mb-1 block" data-i18n="soilType">Soil Type</label>
                        <select id="soilType" class="w-full p-3 rounded-lg border bg-gray-50 focus:ring-2 focus:ring-green-500"></select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-600 mb-1 block" data-i18n="landSize">Land Size</label>
                        <div class="flex">
                            <input id="landSize" type="number" value="2" class="w-2/3 p-3 rounded-l-lg border bg-gray-50 border-r-0 focus:ring-0">
                            <select id="landUnit" class="w-1/3 p-3 rounded-r-lg border bg-gray-100 text-sm border-l-0">
                                <option value="acres" data-i18n="acres">Ac</option>
                                <option value="hectares" data-i18n="hectares">Ha</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600 mb-1 block" data-i18n="startDate">Start Date</label>
                        <input id="startDate" type="date" class="w-full p-3 rounded-lg border bg-gray-50">
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-700 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-green-800 transition flex justify-center items-center">
                    <span data-i18n="genPlan">Generate Smart Plan</span> <i data-lucide="arrow-right" class="ml-2 h-5 w-5"></i>
                </button>
            </form>
        </div>

        <!-- Planner Results -->
        <div id="planner-results" class="hidden mt-6 space-y-6">
            <div id="crop-recommendations">
                <h3 class="font-bold text-lg mb-3" data-i18n="topRecs">All Crops (Sorted by Match)</h3>
                <div id="recommendations-list" class="space-y-3"></div>
            </div>
            
            <div id="detailed-plan-view" class="hidden">
                <button onclick="backToRecs()" class="mb-4 text-sm text-gray-500 hover:text-green-600 flex items-center"><i data-lucide="arrow-left" class="h-4 w-4 mr-1"></i> <span data-i18n="back">Back</span></button>
                
                <!-- Detailed Header -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800" id="selected-crop-name" data-raw-name="">Crop Name</h2>
                            <p class="text-sm text-gray-500 mt-1" id="plan-meta">Details</p>
                        </div>
                        <div class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold" id="plan-score">--% Match</div>
                    </div>
                    <!-- Market & Profit -->
                    <div class="mt-4 grid grid-cols-2 gap-4 border-t border-gray-100 pt-4">
                        <div>
                            <p class="text-xs text-gray-500" data-i18n="marketPrice">Est. Market Price</p>
                            <p class="font-bold text-lg text-gray-800">тВ╣<span id="market-price">--</span>/qt</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500" data-i18n="revenue">Proj. Revenue</p>
                            <p class="font-bold text-lg text-green-600">тВ╣<span id="proj-revenue">--</span></p>
                        </div>
                    </div>
                </div>

                <!-- Climate & Price Forecast -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Price Predictor -->
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <h3 class="font-bold text-indigo-900 text-sm mb-3 flex items-center"><i data-lucide="trending-up" class="h-4 w-4 mr-2"></i> <span data-i18n="priceForecast">Market Price Forecast</span></h3>
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div class="bg-white p-2 rounded-lg shadow-sm">
                                <p class="text-xs text-gray-500" data-i18n="forecast3m">3 Months</p>
                                <p class="font-bold text-indigo-700 text-lg flex items-center justify-center gap-1">
                                    <span id="price-3m">--</span> <i data-lucide="arrow-up-right" class="h-3 w-3"></i>
                                </p>
                            </div>
                            <div class="bg-white p-2 rounded-lg shadow-sm">
                                <p class="text-xs text-gray-500" data-i18n="forecast6m">6 Months</p>
                                <p class="font-bold text-indigo-700 text-lg flex items-center justify-center gap-1">
                                    <span id="price-6m">--</span> <i data-lucide="arrow-down-right" class="h-3 w-3"></i>
                                </p>
                            </div>
                        </div>
                        <div id="price-status" class="mt-2 text-xs font-bold text-center text-green-700 bg-green-100 py-1 rounded">High Profit Potential</div>
                    </div>

                    <!-- Climate Risk -->
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                        <h3 class="font-bold text-orange-900 text-sm mb-2 flex items-center"><i data-lucide="cloud-lightning" class="h-4 w-4 mr-2"></i> <span data-i18n="climateRisk">Climate Risk Alert</span></h3>
                        <div id="risk-content">
                            <p class="text-xs text-orange-800 mb-2" id="risk-msg">Analyzing rainfall patterns...</p>
                            <div class="flex justify-between items-center bg-white p-2 rounded-lg shadow-sm">
                                <span class="text-xs text-gray-500" data-i18n="sowingWindow">Best Sowing</span>
                                <span class="font-bold text-orange-700" id="sowing-window">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estimated Inputs -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 mb-4">
                    <h3 class="font-semibold text-lg mb-3 text-gray-700" data-i18n="estInputs">Estimated Inputs</h3>
                    <div id="resources" class="grid grid-cols-2 gap-4 text-center"></div>
                </div>

                <!-- Government Schemes -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                    <h3 class="font-bold text-blue-800 text-sm mb-2 flex items-center"><i data-lucide="landmark" class="h-4 w-4 mr-2"></i> <span data-i18n="schemes">Available Schemes</span></h3>
                    <ul id="scheme-list" class="text-sm text-blue-700 space-y-1 list-disc list-inside"></ul>
                </div>

                <!-- Timeline -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="font-bold mb-4" data-i18n="schedule">Action Schedule</h3>
                    <div id="action-schedule" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: CROP DOCTOR -->
    <div id="view-diagnosis" class="view-section hidden animate-fade-in">
        <h2 class="text-xl font-bold mb-4 flex items-center"><i data-lucide="stethoscope" class="mr-2 text-red-600"></i> AI Crop Doctor</h2>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 text-center">
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 mb-4 relative hover:border-green-500 transition">
                <input type="file" id="cropImageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div id="upload-placeholder">
                    <div class="bg-green-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-green-600"><i data-lucide="camera" class="h-8 w-8"></i></div>
                    <p class="font-medium text-gray-700" data-i18n="uploadPhoto">Tap to upload photo</p>
                </div>
                <img id="image-preview" class="hidden max-h-64 mx-auto rounded-lg shadow-sm">
            </div>
            <button id="diagnoseBtn" class="w-full bg-green-700 text-white py-3 rounded-xl font-bold shadow-md disabled:opacity-50 hover:bg-green-800 transition" disabled data-i18n="diagnoseBtn">Diagnose Problem</button>
        </div>
        <div id="diagnosis-result" class="hidden mt-6 bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h3 class="font-bold text-lg mb-2 text-gray-800">Diagnosis Report</h3>
            <div id="diagnosis-content" class="text-sm text-gray-600 leading-relaxed"></div>
        </div>
    </div>

    <!-- VIEW: PROFILE -->
    <div id="view-profile" class="view-section hidden animate-fade-in">
        <h2 class="text-xl font-bold mb-4" data-i18n="profile">Farmer Profile</h2>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <form id="profileForm" class="space-y-4">
                <input type="text" id="pName" placeholder="Name" class="w-full border-b border-gray-300 py-2 focus:outline-none">
                <input type="text" id="pFarm" placeholder="Farm Name" class="w-full border-b border-gray-300 py-2 focus:outline-none">
                <button type="submit" class="w-full bg-gray-900 text-white py-2 rounded-lg text-sm font-semibold" data-i18n="saveProfile">Save Profile</button>
            </form>
        </div>
    </div>
  </main>

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around py-3 px-2 z-20">
    <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center text-gray-400 hover:text-green-700 w-1/4"><i data-lucide="layout-dashboard" class="h-6 w-6"></i><span class="text-[10px]">Home</span></button>
    <button onclick="switchView('planner')" class="nav-item flex flex-col items-center text-gray-400 hover:text-green-700 w-1/4"><i data-lucide="sprout" class="h-6 w-6"></i><span class="text-[10px]">Plan</span></button>
    <button onclick="switchView('diagnosis')" class="nav-item flex flex-col items-center text-gray-400 hover:text-green-700 w-1/4"><i data-lucide="scan-line" class="h-6 w-6"></i><span class="text-[10px]">Doctor</span></button>
    <button onclick="switchView('profile')" class="nav-item flex flex-col items-center text-gray-400 hover:text-green-700 w-1/4"><i data-lucide="user" class="h-6 w-6"></i><span class="text-[10px]">Profile</span></button>
  </nav>

<script>
let currentLang = 'en';
let currentLocation = { lat: 11.6643, lon: 78.1460, name: "Salem" };

// --- TRANSLATIONS ---
const TRANSLATIONS = {
    'en': { 
        'appTitle': 'AgriMate', 'cropPlanner': 'Crop Planner', 'planNew': 'Plan new cultivation', 'cropDoctor': 'Crop Doctor', 'diagnoseDisease': 'Diagnose diseases', 
        'newPlan': 'New Cultivation Plan', 'district': 'District', 'soilType': 'Soil Type', 'landSize': 'Land Size', 'startDate': 'Start Date', 
        'genPlan': 'Generate Smart Plan', 'topRecs': 'All Crops (Sorted by Match)', 'back': 'Back', 'marketPrice': 'Est. Market Price', 
        'revenue': 'Proj. Revenue', 'estInputs': 'Estimated Inputs', 'ecoScore': 'Sustainability Score', 'schemes': 'Available Schemes', 
        'schedule': 'Full Cultivation Schedule', 'uploadPhoto': 'Tap to upload photo', 'diagnoseBtn': 'Diagnose Problem', 
        'profile': 'Farmer Profile', 'saveProfile': 'Save Profile', 'acres': 'Ac', 'hectares': 'Ha', 'fit': 'Match', 'water': 'Water', 
        'fert': 'Fertilizer', 'apply': 'Apply', 'irrigate': 'Irrigate', 'routine': 'Routine Maintenance & Monitoring', 'months': 'Month', 
        'noSchemes': 'No specific schemes listed.', 'priceForecast': 'Market Price Forecast', 'climateRisk': 'Climate Risk Alert', 
        'forecast3m': '3 Months', 'forecast6m': '6 Months', 'sowingWindow': 'Best Sowing', 'safeBet': 'Financially Safe', 
        'riskyBet': 'Market Volatile', 'droughtRisk': 'Drought Risk: High', 'floodRisk': 'Flood Risk: High', 'safeRisk': 'Conditions Favorable'
    },
    'ta': { 
        'appTitle': 'роЕроХрпНро░ро┐роорпЗроЯрпН', 'cropPlanner': 'рокропро┐ро░рпН родро┐роЯрпНроЯрооро┐роЯро▓рпН', 'planNew': 'рокрпБродро┐роп роЪро╛роХрпБрокроЯро┐ родро┐роЯрпНроЯроорпН', 'cropDoctor': 'рокропро┐ро░рпН рооро░рпБродрпНродрпБро╡ро░рпН', 'diagnoseDisease': 'роирпЛропрпНроХро│рпИроХрпН роХрогрпНроЯро▒ро┐ропро╡рпБроорпН', 
        'newPlan': 'рокрпБродро┐роп роЪро╛роХрпБрокроЯро┐ родро┐роЯрпНроЯроорпН', 'district': 'рооро╛ро╡роЯрпНроЯроорпН', 'soilType': 'роорогрпН ро╡роХрпИ', 'landSize': 'роиро┐ро▓ роЕро│ро╡рпБ', 'startDate': 'родрпКроЯроХрпНроХ родрпЗродро┐', 
        'genPlan': 'родро┐роЯрпНроЯродрпНродрпИ роЙро░рпБро╡ро╛роХрпНроХрпБ', 'topRecs': 'роЕройрпИродрпНродрпБ рокропро┐ро░рпНроХро│рпН (рокрпКро░рпБродрпНродродрпНродро┐ройрпН рокроЯро┐)', 'back': 'родро┐ро░рпБроорпНрок', 'marketPrice': 'роЪроирпНродрпИ ро╡ро┐ро▓рпИ', 
        'revenue': 'ро╡ро░рпБрооро╛ройроорпН', 'estInputs': 'роородро┐рокрпНрокро┐роЯрокрпНрокроЯрпНроЯ роЙро│рпНро│рпАроЯрпБроХро│рпН', 'ecoScore': 'роиро┐ро▓рпИродрпНродройрпНроорпИ роородро┐рокрпНрокрпАроЯрпБ', 'schemes': 'родро┐роЯрпНроЯроЩрпНроХро│рпН', 
        'schedule': 'роорпБро┤рпБ роЪро╛роХрпБрокроЯро┐ роЕроЯрпНроЯро╡рогрпИ', 'uploadPhoto': 'рокрпБроХрпИрокрпНрокроЯроорпН рокродро┐ро╡рпЗро▒рпНро▒ро╡рпБроорпН', 'diagnoseBtn': 'роХрогрпНроЯро▒ро┐ропро╡рпБроорпН', 
        'profile': 'ро╡ро┐ро╡роЪро╛ропро┐ роЪрпБропро╡ро┐ро╡ро░роорпН', 'saveProfile': 'роЪрпЗрооро┐', 'acres': 'роПроХрпНроХро░рпН', 'hectares': 'ро╣рпЖроХрпНроЯрпЗро░рпН', 'fit': 'рокрпКро░рпБродрпНродроорпН', 
        'water': 'родрогрпНрогрпАро░рпН', 'fert': 'роЙро░роорпН', 'apply': 'роЗроЯро╡рпБроорпН', 'irrigate': 'роирпАро░рпНрокрпНрокро╛роЪройроорпН', 'routine': 'ро╡ро┤роХрпНроХрооро╛рой рокро░ро╛рооро░ро┐рокрпНрокрпБ & роХрогрпНроХро╛рогро┐рокрпНрокрпБ', 'months': 'рооро╛родроорпН', 
        'noSchemes': 'роХрпБро▒ро┐рокрпНрокро┐роЯрпНроЯ родро┐роЯрпНроЯроЩрпНроХро│рпН роОродрпБро╡рпБроорпН роЗро▓рпНро▓рпИ.', 'priceForecast': 'роЪроирпНродрпИ ро╡ро┐ро▓рпИ роорпБройрпНройро▒ро┐ро╡ро┐рокрпНрокрпБ', 'climateRisk': 'роХро╛ро▓роиро┐ро▓рпИ роОроЪрпНроЪро░ро┐роХрпНроХрпИ',
        'forecast3m': '3 рооро╛родроЩрпНроХро│рпН', 'forecast6m': '6 рооро╛родроЩрпНроХро│рпН', 'sowingWindow': 'роЪро┐ро▒роирпНрод ро╡ро┐родрпИрокрпНрокрпБ роХро╛ро▓роорпН', 'safeBet': 'роиро┐родро┐ ро░рпАродро┐ропро╛роХ рокро╛родрпБроХро╛рокрпНрокро╛ройродрпБ', 
        'riskyBet': 'роЪроирпНродрпИ роиро┐ро▓рпИропро▒рпНро▒родрпБ', 'droughtRisk': 'ро╡ро▒роЯрпНроЪро┐ роЕрокро╛ропроорпН', 'floodRisk': 'ро╡рпЖро│рпНро│ роЕрокро╛ропроорпН', 'safeRisk': 'роЪро╛родроХрооро╛рой роЪрпВро┤ро▓рпН'
    }
};

const TASK_TRANSLATIONS = { 'Sowing': 'ро╡ро┐родрпИрокрпНрокрпБ', 'Planting': 'роироЯро╡рпБ', 'Harvesting': 'роЕро▒рпБро╡роЯрпИ', 'Fertilizer': 'роЙро░роорпН', 'Watering': 'родрогрпНрогрпАро░рпН', 'Flowering': 'рокрпВроХрпНроХрпБроорпН', 'Nursery': 'роиро╛ро▒рпНро▒роЩрпНроХро╛ро▓рпН', 'Transplanting': 'роиро╛ро▒рпНро▒рпБ роироЯрпБродро▓рпН', 'Picking': 'рокро▒ро┐родрпНродро▓рпН', 'Earthing Up': 'роорогрпН роЕрогрпИродрпНродро▓рпН', 'Vegetative': 'ро╡ро│ро░рпНроЪрпНроЪро┐рокрпН рокро░рпБро╡роорпН', 'Maturation': 'роорпБродро┐ро░рпНроЪрпНроЪро┐ роиро┐ро▓рпИ', 'Preparation': 'роиро┐ро▓роорпН родропро╛ро░рпНрокроЯрпБродрпНродрпБродро▓рпН', 'Weeding': 'роХро│рпИ роОроЯрпБродрпНродро▓рпН', 'Grand Growth': 'рокрпЖро░рпБроорпН ро╡ро│ро░рпНроЪрпНроЪро┐рокрпН рокро░рпБро╡роорпН', 'Formative': 'роЙро░рпБро╡ро╛роХрпНроХ роиро┐ро▓рпИ', 'Seedling': 'роиро╛ро▒рпНро▒рпБ ро╡ро│ро░рпНроЪрпНроЪро┐', 'Yield Formation': 'роороХроЪрпВро▓рпН роЙро░рпБро╡ро╛роХрпНроХроорпН', 'Tillering': 'родрпВро░рпНроХроЯрпНроЯрпБродро▓рпН' };

const SCHEME_TRANSLATIONS = { "PM Fasal Bima Yojana": "рокро┐ро░родроо роороирпНродро┐ро░ро┐ рокропро┐ро░рпН роХро╛рокрпНрокрпАроЯрпНроЯрпБродрпН родро┐роЯрпНроЯроорпН", "TN Paddy Mission": "родрооро┐ро┤рпНроиро╛роЯрпБ роирпЖро▓рпН роЗропроХрпНроХроорпН", "NFSM": "родрпЗроЪро┐роп роЙрогро╡рпБ рокро╛родрпБроХро╛рокрпНрокрпБ родро┐роЯрпНроЯроорпН", "Millet Mission": "роЪро┐ро▒рпБродро╛ройро┐роп роЗропроХрпНроХроорпН", "FRP Support": "роХро░рпБроорпНрокрпБроХрпНроХро╛рой роиро┐ропро╛роп ро╡ро┐ро▓рпИ роЖродро░ро╡рпБ", "CCI Support": "рокро░рпБродрпНродро┐ роХро┤роХ роЖродро░ро╡рпБ", "General": "рокрпКродрпБ ро╡ро┐ро╡роЪро╛ропродрпН родро┐роЯрпНроЯроЩрпНроХро│рпН", "NFSM Pulses": "родрпЗроЪро┐роп роЙрогро╡рпБ рокро╛родрпБроХро╛рокрпНрокрпБ родро┐роЯрпНроЯроорпН (рокро░рпБрокрпНрокрпБ)", "Oilseed Mission": "роОрогрпНрогрпЖропрпН ро╡ро┐родрпНродрпБроХрпНроХро│рпН роЗропроХрпНроХроорпН", "CDB Subsidy": "родрпЖройрпНройрпИ ро╡ро│ро░рпНроЪрпНроЪро┐ ро╡ро╛ро░ро┐роп рооро╛ройро┐ропроорпН", "Horticulture": "родрпЛроЯрпНроЯроХрпНроХро▓рпИродрпН родрпБро▒рпИ рооро╛ройро┐ропроорпН", "Horticulture Mission": "родрпЗроЪро┐роп родрпЛроЯрпНроЯроХрпНроХро▓рпИ роЗропроХрпНроХроорпН", "NHRDF": "родрпЗроЪро┐роп родрпЛроЯрпНроЯроХрпНроХро▓рпИ роЖро░ро╛ропрпНроЪрпНроЪро┐ рооро▒рпНро▒рпБроорпН роорпЗроорпНрокро╛роЯрпНроЯрпБ роиро┐ро▒рпБро╡ройроорпН", "Spices Board": "ро╡ро╛роЪройрпИрокрпН рокрпКро░рпБроЯрпНроХро│рпН ро╡ро╛ро░ро┐ропроорпН", "Tea Board": "родрпЗропро┐ро▓рпИ ро╡ро╛ро░ро┐ропроорпН", "Coffee Board": "роХро╛рокро┐ ро╡ро╛ро░ро┐ропроорпН" };

const CROP_TRANSLATIONS = { 'Rice (Paddy)': 'роирпЖро▓рпН (Rice)', 'Sugarcane': 'роХро░рпБроорпНрокрпБ (Sugarcane)', 'Cotton': 'рокро░рпБродрпНродро┐ (Cotton)', 'Tomato': 'родроХрпНроХро╛ро│ро┐ (Tomato)', 'Banana': 'ро╡ро╛ро┤рпИ (Banana)', 'Sorghum': 'роЪрпЛро│роорпН (Sorghum)', 'Millets': 'роЪро┐ро▒рпБродро╛ройро┐ропроЩрпНроХро│рпН (Millets)', 'Pulses': 'рокро░рпБрокрпНрокрпБ (Pulses)' };

const MOCK_DISEASES = [
    { en: `<b>Diagnosis:</b> Early Blight<br><b>Remedy:</b> Apply Mancozeb.`, ta: `<b>роирпЛропрпН:</b> роорпБройрпН рокро░рпБро╡ роХро░рпБроХро▓рпН роирпЛропрпН<br><b>родрпАро░рпНро╡рпБ:</b> роорпЗроЩрпНроХрпЛроЪрпЖрокрпН родрпЖро│ро┐роХрпНроХро╡рпБроорпН.` },
    { en: `<b>Diagnosis:</b> Leaf Spot<br><b>Remedy:</b> Spray Copper Oxychloride.`, ta: `<b>роирпЛропрпН:</b> роЗро▓рпИрокрпНрокрпБро│рпНро│ро┐ роирпЛропрпН<br><b>родрпАро░рпНро╡рпБ:</b> роХро╛рокрпНрокро░рпН роЖроХрпНроЪро┐ роХрпБро│рпЛро░рпИроЯрпБ родрпЖро│ро┐роХрпНроХро╡рпБроорпН.` },
    { en: `<b>Diagnosis:</b> Aphids<br><b>Remedy:</b> Use Neem Oil.`, ta: `<b>роирпЛропрпН:</b> роЕроЪрпБро╡ро┐ройро┐ рокрпВроЪрпНроЪро┐<br><b>родрпАро░рпНро╡рпБ:</b> ро╡рпЗрокрпНрок роОрогрпНрогрпЖропрпН рокропройрпНрокроЯрпБродрпНродро╡рпБроорпН.` }
];

const SOIL_TYPES = [ { val: "Alluvial", en: "Alluvial Soil", ta: "ро╡рогрпНроЯро▓рпН роорогрпН" }, { val: "Black", en: "Black Soil", ta: "роХро░ро┐роЪро▓рпН роорогрпН" }, { val: "Red", en: "Red Soil", ta: "роЪрпЖроорпНроорогрпН" }, { val: "Clay", en: "Clay Soil", ta: "роХро│ро┐роорогрпН" }, { val: "Sandy", en: "Sandy Soil", ta: "роорогро▓рпН рокро╛роЩрпНроХро╛рой роорогрпН" }, { val: "Loamy", en: "Loamy Soil", ta: "ро╡ро│роорпН рооро┐роХрпБроирпНрод роорогрпН" }, { val: "Sandy Loam", en: "Sandy Loam", ta: "роорогро▓рпН роХро▓роирпНрод ро╡рогрпНроЯро▓рпН роорогрпН" }, { val: "Clay Loam", en: "Clay Loam", ta: "роХро│ро┐роорогрпН роХро▓роирпНрод ро╡рогрпНроЯро▓рпН" }, { val: "Silty", en: "Silty Soil", ta: "роорпЖройрпНроорпИропро╛рой ро╡рогрпНроЯро▓рпН роорогрпН" }, { val: "Laterite", en: "Laterite Soil", ta: "роЪрпЖроорпНрокрпВро░ро╛ройрпН роорогрпН" }, { val: "Peaty", en: "Peaty Soil", ta: "роороХрпНроХро┐роп роорогрпН" }, { val: "Chalky", en: "Chalky Soil", ta: "роЪрпБрогрпНрогро╛роорпНрокрпБ роорогрпН" }, { val: "Saline", en: "Saline Soil", ta: "роЙро╡ро░рпН роорогрпН" }, { val: "Gravel", en: "Gravelly Soil", ta: "роЪро░ро│рпИ роорогрпН" } ];

const DISTRICTS = [ "Ariyalur", "Chengalpattu", "Chennai", "Coimbatore", "Cuddalore", "Dharmapuri", "Dindigul", "Erode", "Kallakurichi", "Kanchipuram", "Kanyakumari", "Karur", "Krishnagiri", "Madurai", "Mayiladuthurai", "Nagapattinam", "Namakkal", "Nilgiris", "Perambalur", "Pudukkottai", "Ramanathapuram", "Ranipet", "Salem", "Sivaganga", "Tenkasi", "Thanjavur", "Theni", "Thoothukudi", "Tiruchirappalli", "Tirunelveli", "Tirupathur", "Tiruppur", "Tiruvallur", "Tiruvannamalai", "Tiruvarur", "Vellore", "Viluppuram", "Virudhunagar" ];
const DISTRICT_TA = { "Ariyalur": "роЕро░ро┐ропро▓рпВро░рпН", "Chengalpattu": "роЪрпЖроЩрпНроХро▓рпНрокроЯрпНроЯрпБ", "Chennai": "роЪрпЖройрпНройрпИ", "Coimbatore": "роХрпЛропроорпНрокрпБродрпНродрпВро░рпН", "Cuddalore": "роХроЯро▓рпВро░рпН", "Dharmapuri": "родро░рпНроорокрпБро░ро┐", "Dindigul": "родро┐рогрпНроЯрпБроХрпНроХро▓рпН", "Erode": "роИро░рпЛроЯрпБ", "Kallakurichi": "роХро│рпНро│роХрпНроХрпБро▒ро┐роЪрпНроЪро┐", "Kanchipuram": "роХро╛роЮрпНроЪро┐рокрпБро░роорпН", "Kanyakumari": "роХройрпНройро┐ропро╛роХрпБрооро░ро┐", "Karur": "роХро░рпВро░рпН", "Krishnagiri": "роХро┐ро░рпБро╖рпНрогроХро┐ро░ро┐", "Madurai": "роородрпБро░рпИ", "Mayiladuthurai": "рооропро┐ро▓ро╛роЯрпБродрпБро▒рпИ", "Nagapattinam": "роиро╛роХрокрпНрокроЯрпНроЯро┐ройроорпН", "Namakkal": "роиро╛роороХрпНроХро▓рпН", "Nilgiris": "роирпАро▓роХро┐ро░ро┐", "Perambalur": "рокрпЖро░роорпНрокро▓рпВро░рпН", "Pudukkottai": "рокрпБродрпБроХрпНроХрпЛроЯрпНроЯрпИ", "Ramanathapuram": "ро░ро╛роороиро╛родрокрпБро░роорпН", "Ranipet": "ро░ро╛рогро┐рокрпНрокрпЗроЯрпНроЯрпИ", "Salem": "роЪрпЗро▓роорпН", "Sivaganga": "роЪро┐ро╡роХроЩрпНроХрпИ", "Tenkasi": "родрпЖройрпНроХро╛роЪро┐", "Thanjavur": "родроЮрпНроЪро╛ро╡рпВро░рпН", "Theni": "родрпЗройро┐", "Thoothukudi": "родрпВродрпНродрпБроХрпНроХрпБроЯро┐", "Tiruchirappalli": "родро┐ро░рпБроЪрпНроЪро┐ро░ро╛рокрпНрокро│рпНро│ро┐", "Tirunelveli": "родро┐ро░рпБроирпЖро▓рпНро╡рпЗро▓ро┐", "Tirupathur": "родро┐ро░рпБрокрпНрокродрпНродрпВро░рпН", "Tiruppur": "родро┐ро░рпБрокрпНрокрпВро░рпН", "Tiruvallur": "родро┐ро░рпБро╡ро│рпНро│рпВро░рпН", "Tiruvannamalai": "родро┐ро░рпБро╡рогрпНрогро╛рооро▓рпИ", "Tiruvarur": "родро┐ро░рпБро╡ро╛ро░рпВро░рпН", "Vellore": "ро╡рпЗро▓рпВро░рпН", "Viluppuram": "ро╡ро┐ро┤рпБрокрпНрокрпБро░роорпН", "Virudhunagar": "ро╡ро┐ро░рпБродрпБроироХро░рпН" };

const CROP_DB = {
    'Rice (Paddy)': { ta: 'роирпЖро▓рпН', durationMonths: 4, idealSoil: ['Clay', 'Alluvial', 'Clay Loam', 'Silty'], marketPrice: 2200, avgYield: 25, ecoScore: 60, schemes: ["PM Fasal Bima Yojana", "TN Paddy Mission"], waterIntensive: true, schedule: [{ month: 1, task: 'Nursery Prep & Sowing', details: { water: 300000, fert: { 'DAP': 25 } } }, { month: 2, task: 'Transplanting & Tillering', details: { water: 350000, fert: { 'Urea': 50 } } }, { month: 3, task: 'Flowering & Water Mgmt', details: { water: 350000, fert: { 'Urea': 50 } } }, { month: 4, task: 'Harvesting', details: { water: 100000 } }] },
    'Sugarcane': { ta: 'роХро░рпБроорпНрокрпБ', durationMonths: 12, idealSoil: ['Loamy', 'Clay', 'Alluvial'], marketPrice: 315, avgYield: 400, ecoScore: 50, schemes: ["FRP Support"], waterIntensive: true, schedule: [{ month: 1, task: 'Planting', details: { water: 100000, fert: { 'Urea': 75 } } }, { month: 6, task: 'Earthing Up', details: { water: 200000, fert: { 'DAP': 75 } } }, { month: 12, task: 'Harvesting', details: { water: 50000 } }] },
    'Cotton': { ta: 'рокро░рпБродрпНродро┐', durationMonths: 6, idealSoil: ['Black', 'Clay'], marketPrice: 6600, avgYield: 10, ecoScore: 65, schemes: ["CCI Support"], waterIntensive: false, schedule: [{ month: 1, task: 'Sowing', details: { water: 100000, fert: { 'Urea': 40 } } }, { month: 3, task: 'Flowering', details: { water: 150000, fert: { 'Potash': 40 } } }, { month: 6, task: 'Picking', details: { water: 50000 } }] },
    'Tomato': { ta: 'родроХрпНроХро╛ро│ро┐', durationMonths: 4, idealSoil: ['Sandy', 'Loamy', 'Red'], marketPrice: 2500, avgYield: 150, ecoScore: 70, schemes: ["Horticulture"], waterIntensive: false, schedule: [{ month: 1, task: 'Transplanting', details: { water: 50000, fert: { 'DAP': 20 } } }, { month: 4, task: 'Harvesting', details: { water: 70000 } }] },
    'Banana': { ta: 'ро╡ро╛ро┤рпИ', durationMonths: 12, idealSoil: ['Alluvial', 'Red', 'Loamy'], marketPrice: 1500, avgYield: 300, ecoScore: 75, schemes: ["Horticulture Mission"], waterIntensive: true, schedule: [{ month: 1, task: 'Planting', details: { water: 200000 } }, { month: 6, task: 'Grand Growth', details: { water: 250000 } }, { month: 12, task: 'Harvesting', details: {} }] },
    'Sorghum': { ta: 'роЪрпЛро│роорпН', durationMonths: 4, idealSoil: ['Black', 'Red'], marketPrice: 3000, avgYield: 12, ecoScore: 85, schemes: ["Millet Mission"], waterIntensive: false, schedule: [{ month: 1, task: 'Sowing', details: { water: 60000 } }, { month: 4, task: 'Harvesting', details: { water: 70000 } }] }
};

// --- INIT ---
window.onload = () => {
    lucide.createIcons();
    populateDropdowns();
    document.getElementById('startDate').valueAsDate = new Date();
    updateMarketTicker();
    detectLocation();
};

document.getElementById('languageSelector').addEventListener('change', (e) => {
    currentLang = e.target.value;
    updateLanguage();
});

function t(key) { return TRANSLATIONS[currentLang][key] || key; }

function updateLanguage() {
    document.querySelectorAll('[data-i18n]').forEach(el => { el.innerText = t(el.getAttribute('data-i18n')); });
    populateDropdowns();
}

function translateText(text) {
    if (currentLang === 'en') return text;
    let translated = text;
    for (const [eng, ta] of Object.entries(TASK_TRANSLATIONS)) {
        if (translated.includes(eng)) translated = translated.replace(eng, ta);
    }
    return translated;
}

function populateDropdowns() {
    const dSelect = document.getElementById('district');
    const sSelect = document.getElementById('soilType');
    dSelect.innerHTML = ''; sSelect.innerHTML = '';
    DISTRICTS.forEach(d => { let o = document.createElement('option'); o.value = d; o.text = (currentLang === 'ta' && DISTRICT_TA[d]) ? DISTRICT_TA[d] : d; dSelect.add(o); });
    SOIL_TYPES.forEach(s => { let o = document.createElement('option'); o.value = s.val; o.text = (currentLang === 'ta') ? s.ta : s.en; sSelect.add(o); });
}

function updateMarketTicker() {
    const ticker = document.getElementById('market-ticker');
    // Simulated prices
    const prices = [
        { name: "Paddy", price: "тВ╣2200/q", change: "+2%" },
        { name: "Cotton", price: "тВ╣6600/q", change: "-1%" },
        { name: "Tomato", price: "тВ╣2500/q", change: "+5%" },
        { name: "Turmeric", price: "тВ╣7000/q", change: "+0.5%" }
    ];
    ticker.innerHTML = prices.map(p => `<span class="mx-4">${p.name}: ${p.price} (${p.change})</span>`).join(' тАв ');
}

// --- PLANNER ---
document.getElementById('planForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const soil = document.getElementById('soilType').value;
    const landSize = document.getElementById('landSize').value;
    const recs = document.getElementById('recommendations-list');
    recs.innerHTML = '';
    
    // Sort logic simplified for stability
    Object.keys(CROP_DB).forEach(crop => {
        const data = CROP_DB[crop];
        let score = data.idealSoil.includes(soil) ? 90 : 60;
        const cropNameDisplay = (currentLang === 'ta' && data.ta) ? data.ta : crop;
        
        const card = document.createElement('div');
        card.className = "bg-white border border-gray-100 p-4 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:border-green-500 transition";
        card.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center text-green-700 font-bold">${crop.charAt(0)}</div>
                <div><h4 class="font-bold text-gray-800">${cropNameDisplay}</h4><p class="text-xs text-gray-500">${data.durationMonths} ${t('months')}</p></div>
            </div>
            <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">${score}% ${t('fit')}</span>
        `;
        card.onclick = () => loadDetailedPlan(crop, landSize);
        recs.appendChild(card);
    });
    document.getElementById('planner-results').classList.remove('hidden');
});

function loadDetailedPlan(cropName, landSize) {
    const data = CROP_DB[cropName];
    if (!data) return;

    document.getElementById('crop-recommendations').classList.add('hidden');
    document.getElementById('detailed-plan-view').classList.remove('hidden');
    
    const displayCrop = (currentLang === 'ta' && data.ta) ? data.ta : cropName;
    const nameEl = document.getElementById('selected-crop-name');
    if (nameEl) { nameEl.innerText = displayCrop; nameEl.setAttribute('data-raw-name', cropName); }
    
    const soilEl = document.getElementById('soilType');
    const unitEl = document.getElementById('landUnit');
    const metaEl = document.getElementById('plan-meta');
    if(metaEl && soilEl && unitEl) metaEl.innerText = `${landSize} ${unitEl.value} тАв ${soilEl.value}`;

    const mpEl = document.getElementById('market-price');
    if (mpEl) mpEl.innerText = data.marketPrice;
    
    const revEl = document.getElementById('proj-revenue');
    if (revEl) {
        const revenue = data.marketPrice * data.avgYield * landSize;
        revEl.innerText = revenue.toLocaleString();
    }
    
    const p3m = Math.round(data.marketPrice * (1 + (Math.random() * 0.15 - 0.05)));
    const p6m = Math.round(data.marketPrice * (1 + (Math.random() * 0.25 - 0.1)));
    const p3mEl = document.getElementById('price-3m');
    const p6mEl = document.getElementById('price-6m');
    if(p3mEl) p3mEl.innerText = `тВ╣${p3m}`;
    if(p6mEl) p6mEl.innerText = `тВ╣${p6m}`;
    
    const priceStatus = document.getElementById('price-status');
    if(priceStatus) {
        if(p6m > data.marketPrice * 1.1) {
            priceStatus.innerText = t('safeBet');
            priceStatus.className = "mt-2 text-xs font-bold text-center text-green-700 bg-green-100 py-1 rounded";
        } else {
            priceStatus.innerText = t('riskyBet');
            priceStatus.className = "mt-2 text-xs font-bold text-center text-orange-700 bg-orange-100 py-1 rounded";
        }
    }

    const riskMsg = document.getElementById('risk-msg');
    const sowWindow = document.getElementById('sowing-window');
    
    const isDrought = Math.random() > 0.5; 
    if(riskMsg) {
        if (data.waterIntensive && isDrought) {
            riskMsg.innerText = t('droughtRisk');
            riskMsg.className = "text-xs text-red-700 mb-2 font-bold";
        } else if (!data.waterIntensive && !isDrought) {
            riskMsg.innerText = t('floodRisk'); 
            riskMsg.className = "text-xs text-orange-700 mb-2 font-bold";
        } else {
            riskMsg.innerText = t('safeRisk');
            riskMsg.className = "text-xs text-green-700 mb-2 font-bold";
        }
    }
    
    if(sowWindow) {
        const nextMonth = new Date();
        nextMonth.setMonth(nextMonth.getMonth() + 2);
        const monthName = nextMonth.toLocaleString('en-US', { month: 'long' });
        // Simple manual translation map for months in this scope
        const monthTa = { "January":"роЬройро╡ро░ро┐", "February":"рокро┐рокрпНро░ро╡ро░ро┐", "March":"рооро╛ро░рпНроЪрпН", "April":"роПрокрпНро░ро▓рпН", "May":"роорпЗ", "June":"роЬрпВройрпН", "July":"роЬрпВро▓рпИ", "August":"роЖроХро╕рпНроЯрпН", "September":"роЪрпЖрокрпНроЯроорпНрокро░рпН", "October":"роЕроХрпНроЯрпЛрокро░рпН", "November":"роиро╡роорпНрокро░рпН", "December":"роЯро┐роЪроорпНрокро░рпН" };
        sowWindow.innerText = currentLang === 'ta' ? monthTa[monthName] : monthName;
    }

    const schemeList = document.getElementById('scheme-list');
    if(schemeList) {
        schemeList.innerHTML = '';
        if(data.schemes && data.schemes.length > 0) {
            data.schemes.forEach(s => { 
                const schemeName = (currentLang === 'ta' && SCHEME_TRANSLATIONS[s]) ? SCHEME_TRANSLATIONS[s] : s;
                schemeList.innerHTML += `<li>${schemeName}</li>`; 
            });
        } else { schemeList.innerHTML = `<li>${t('noSchemes')}</li>`; }
    }
    
    const resDiv = document.getElementById('resources');
    if(resDiv) {
        let totalWater = 0; let totalFert = {};
        
        // Sum up from all months in the duration
        // We will loop through the full duration for the timeline anyway, 
        // so we can use the schedule map logic here too.
        const scheduleMap = {};
        data.schedule.forEach(s => scheduleMap[s.month] = s);

        for(let m=1; m<=data.durationMonths; m++) {
             const item = scheduleMap[m];
             if(item && item.details) {
                 if(item.details.water) totalWater += item.details.water;
                 if(item.details.fert) {
                    for(let [key, val] of Object.entries(item.details.fert)) {
                        totalFert[key] = (totalFert[key] || 0) + val;
                    }
                 }
             }
        }
        
        let resHtml = `<div class="bg-blue-50 p-3 rounded-lg"><p class="text-xs text-blue-600 font-semibold">${t('water')}</p><p class="font-bold text-blue-800">${(totalWater * landSize).toLocaleString()} L</p></div>`;
        for(let [key, val] of Object.entries(totalFert)) { resHtml += `<div class="bg-yellow-50 p-3 rounded-lg"><p class="text-xs text-yellow-600 font-semibold">${key} ${t('fert')}</p><p class="font-bold text-yellow-800">${(val * landSize)} Kg</p></div>`; }
        resDiv.innerHTML = resHtml;
    }

    const tlDiv = document.getElementById('action-schedule');
    if(tlDiv) {
        tlDiv.innerHTML = '';
        // Create a map for easy lookup
        const scheduleMap = {};
        data.schedule.forEach(s => scheduleMap[s.month] = s);

        // Loop from Month 1 to Duration
        for (let month = 1; month <= data.durationMonths; month++) {
            const item = scheduleMap[month];
            let taskName, detailsText = '';

            if (item) {
                taskName = translateText(item.task);
                if(item.details) {
                    if(item.details.water) detailsText += `<span class="text-blue-600 text-xs block">ЁЯТз ${t('irrigate')} ${(item.details.water * landSize).toLocaleString()} L</span>`;
                    if(item.details.fert) {
                        const f = Object.entries(item.details.fert).map(([k,v]) => `${v*landSize}kg ${k}`).join(', ');
                        detailsText += `<span class="text-yellow-600 text-xs block">ЁЯМ▒ ${t('apply')} ${f}</span>`;
                    }
                }
            } else {
                taskName = t('routine');
                detailsText = `<span class="text-gray-400 text-xs">${currentLang === 'ta' ? 'роХрогрпНроХро╛рогро┐рокрпНрокрпБ' : 'Monitoring'}</span>`;
            }

            tlDiv.innerHTML += `
                <div class="bg-white border-l-4 border-green-500 p-3 shadow-sm rounded-r-lg">
                    <div class="flex justify-between">
                        <h4 class="font-bold text-gray-800">${taskName}</h4>
                        <span class="text-xs font-bold text-gray-400">${t('months')} ${month}</span>
                    </div>
                    <div class="mt-1">${detailsText}</div>
                </div>
            `;
        }
    }
}

function backToRecs() {
    document.getElementById('detailed-plan-view').classList.add('hidden');
    document.getElementById('crop-recommendations').classList.remove('hidden');
}

// --- LOCATION ---
async function detectLocation() {
    const btn = document.getElementById('locationBtn');
    btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin h-5 w-5"></i>';
    lucide.createIcons();
    if (!navigator.geolocation) { fallbackLocation(btn); return; }
    const geoTimeout = setTimeout(() => fallbackLocation(btn), 5000);
    navigator.geolocation.getCurrentPosition(async (position) => {
        clearTimeout(geoTimeout);
        const lat = position.coords.latitude; const lon = position.coords.longitude;
        currentLocation = { lat, lon, name: "Detected" };
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await response.json();
            currentLocation.name = (data.address.state_district || data.address.city || "Unknown").replace(' District', '');
            updateLocationUI(); fetchWeather(lat, lon);
        } catch (e) { updateLocationUI(); fetchWeather(lat, lon); }
        btn.innerHTML = '<i data-lucide="map-pin" class="h-5 w-5"></i>'; lucide.createIcons();
    }, () => { clearTimeout(geoTimeout); fallbackLocation(btn); });
}

function fallbackLocation(btn) {
    if(event && event.type === 'click') alert(currentLang === 'ta' ? "роЗро░рпБрокрпНрокро┐роЯроорпН роХрогрпНроЯро▒ро┐роп роорпБроЯро┐ропро╡ро┐ро▓рпНро▓рпИ. роЪрпЗро▓роорпН рокропройрпНрокроЯрпБродрпНродрокрпНрокроЯрпБроХро┐ро▒родрпБ." : "Using default location (Salem).");
    currentLocation = { lat: 11.6643, lon: 78.1460, name: "Salem" };
    updateLocationUI(); fetchWeather(currentLocation.lat, currentLocation.lon);
    btn.innerHTML = '<i data-lucide="map-pin" class="h-5 w-5"></i>'; lucide.createIcons();
}

function updateLocationUI() {
    let displayName = currentLocation.name;
    if(currentLang === 'ta' && DISTRICT_TA[currentLocation.name]) displayName = DISTRICT_TA[currentLocation.name];
    document.getElementById('dash-location').innerText = displayName;
}

async function fetchWeather(lat, lon) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m,precipitation&timezone=auto`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        document.getElementById('dash-temp').innerText = `${Math.round(data.current.temperature_2m)}┬░C`;
        document.getElementById('dash-wind').innerText = `${data.current.wind_speed_10m} km/h`;
        document.getElementById('dash-rain').innerText = `${data.current.precipitation} mm`;
    } catch (e) {}
}

function switchView(view) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
    document.getElementById(`view-${view}`).classList.remove('hidden');
    window.scrollTo(0,0);
}

// --- DOCTOR ---
document.getElementById('cropImageInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('image-preview').src = e.target.result;
            document.getElementById('image-preview').classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');
            document.getElementById('diagnoseBtn').disabled = false;
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('diagnoseBtn').addEventListener('click', () => {
    const btn = document.getElementById('diagnoseBtn');
    btn.innerText = (currentLang === 'ta') ? "рокроХрпБрокрпНрокро╛ропрпНро╡рпБ..." : "Analyzing...";
    const randomDisease = MOCK_DISEASES[Math.floor(Math.random() * MOCK_DISEASES.length)];
    setTimeout(() => {
        btn.innerText = (currentLang === 'ta') ? "роХрогрпНроЯро▒ро┐ропро╡рпБроорпН" : "Diagnose Problem";
        document.getElementById('diagnosis-result').classList.remove('hidden');
        document.getElementById('diagnosis-content').innerHTML = randomDisease[currentLang];
    }, 2000);
});

function loadProfile() { /* Standard LocalStorage Logic */ }
</script>
</body>
</html>
